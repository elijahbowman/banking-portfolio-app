AWSTemplateFormatVersion: '2010-09-09'
Description: Core infrastructure for banking-service (RDS, Kafka, S3, DynamoDB)
Parameters:
  RDSDBName:
    Type: String
    Default: bankingdb
  RDSUsername:
    Type: String
    Default: bank_admin
  InstanceType:
    Type: String
    Default: t3.micro
  InstanceType2:
    Type: String
    Default: t3.small
  VpcId:
    Type: AWS::EC2::VPC::Id
  SubnetId1:
    Type: AWS::EC2::Subnet::Id
    Description: First subnet for RDS and Kafka (e.g., us-east-1a)
  SubnetId2:
    Type: AWS::EC2::Subnet::Id
    Description: Second subnet for RDS (e.g., us-east-1b)
  KeyName:
    Type: AWS::EC2::KeyPair::KeyName
  YourIP:
    Type: String
    Description: Your public IP for SSH access (e.g., 203.0.113.0/32) # Temporary for SSH
    Default: 0.0.0.0/0
Resources:
  ArtifactsBucket:
    Type: AWS::S3::Bucket
    Properties:
      BucketName: banking-portfolio-artifacts
      PublicAccessBlockConfiguration:
        BlockPublicAcls: true
        BlockPublicPolicy: true
        IgnorePublicAcls: true
        RestrictPublicBuckets: true
    DeletionPolicy: Delete
  RDSSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for banking-postgres RDS
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          SourceSecurityGroupId: !Ref EBSecurityGroup
        - IpProtocol: tcp
          FromPort: 5432
          ToPort: 5432
          CidrIp: !Ref YourIP  # Temporary for SSH
  EBSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for banking-env EB
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 80
          ToPort: 80
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8080
          ToPort: 8080
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8081
          ToPort: 8081
          CidrIp: 0.0.0.0/0
        - IpProtocol: tcp
          FromPort: 8082
          ToPort: 8082
          CidrIp: 0.0.0.0/0
      SecurityGroupEgress:
        - IpProtocol: -1
          FromPort: 0
          ToPort: 65535
          CidrIp: 0.0.0.0/0
  KafkaSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Security group for Kafka and Zookeeper
      VpcId: !Ref VpcId
      SecurityGroupIngress:
        - IpProtocol: tcp
          FromPort: 9092
          ToPort: 9092
          SourceSecurityGroupId: !Ref EBSecurityGroup
        - IpProtocol: tcp
          FromPort: 2181
          ToPort: 2181
          SourceSecurityGroupId: !Ref EBSecurityGroup
        - IpProtocol: tcp
          FromPort: 22
          ToPort: 22
          CidrIp: !Ref YourIP  # Temporary for SSH
      SecurityGroupEgress:
      - IpProtocol: -1
        FromPort: 0
        ToPort: 65535
        CidrIp: 0.0.0.0/0  # Allow all outbound for apt, snap, and Kafka
  KafkaInstanceRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      ManagedPolicyArns:
        - arn:aws:iam::aws:policy/AmazonSSMManagedInstanceCore
      Policies:
        - PolicyName: EC2InstanceConnect
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - ec2-instance-connect:SendSSHPublicKey
                Resource: !Sub arn:aws:ec2:${AWS::Region}:${AWS::AccountId}:instance/*
                Condition:
                  StringEquals:
                    ec2:osuser: ubuntu
  KafkaInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref KafkaInstanceRole
  BankingPostgres:
    Type: AWS::RDS::DBInstance
    Properties:
      DBInstanceIdentifier: banking-postgres
      DBName: !Ref RDSDBName
      AllocatedStorage: 20
      DBInstanceClass: !Sub db.${InstanceType}
      Engine: postgres
      EngineVersion: 17.5
      MasterUsername: !Ref RDSUsername
      MasterUserPassword: !Sub '{{resolve:ssm-secure:/banking/rds/password}}'
      VPCSecurityGroups:
        - !Ref RDSSecurityGroup
      DBSubnetGroupName: !Ref DBSubnetGroup
      PubliclyAccessible: true
  DBSubnetGroup:
    Type: AWS::RDS::DBSubnetGroup
    Properties:
      DBSubnetGroupDescription: Subnet group for banking-postgres
      SubnetIds:
        - !Ref SubnetId1
        - !Ref SubnetId2
  KafkaZookeeperInstance:
    Type: AWS::EC2::Instance
    Properties:
      InstanceType: !Ref InstanceType2
      ImageId: ami-052064a798f08f0d3
      KeyName: !Ref KeyName
      SubnetId: !Ref SubnetId1
      SecurityGroupIds:
        - !Ref KafkaSecurityGroup
      IamInstanceProfile: !Ref KafkaInstanceProfile
      UserData:
        Fn::Base64: !Sub |
          #!/bin/bash
          yum update -y
          yum install docker -y
          systemctl enable docker
          systemctl start docker
          curl -L "https://github.com/docker/compose/releases/download/v2.29.2/docker-compose-$(uname -s)-$(uname -m)" -o /usr/local/bin/docker-compose
          chmod +x /usr/local/bin/docker-compose
          cat << EOF > /home/ec2-user/docker-compose.yml
          version: '3.8'
          services:
            zookeeper:
              image: bitnamilegacy/zookeeper:3.9
              container_name: zookeeper
              ports:
                - "2181:2181"
              environment:
                ZOO_PORT_NUMBER: 2181
                ALLOW_ANONYMOUS_LOGIN: yes
              volumes:
                - zookeeper_data:/bitnami/zookeeper
              networks:
                - kafka-network
              restart: unless-stopped
              healthcheck:
                # test: ["CMD", "nc", "-z", "localhost", "2181"]
                test: ["CMD", "zkServer.sh", "status"]
                interval: 10s
                timeout: 5s
                retries: 10
                start_period: 60s
            kafka:
              image: bitnamilegacy/kafka:3.7
              container_name: kafka
              ports:
                - "9092:9092"
              environment:
                KAFKA_CFG_ZOOKEEPER_CONNECT: __PRIVATE_IP__:2181
                KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://__PRIVATE_IP__:9092
                KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: true
                KAFKA_HEAP_OPTS: -Xmx256m -Xms256m
                KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
                KAFKA_AUTO_CREATE_TOPICS_ENABLE: true
                KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
                KAFKA_CFG_BROKER_ID: 1
                KAFKA_CFG_NUM_PARTITIONS: 1
                KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: 1
                KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
                ALLOW_PLAINTEXT_LISTENER: yes
              depends_on:
                zookeeper:
                  condition: service_healthy
              volumes:
                - kafka_data:/bitnami/kafka
              networks:
                - kafka-network
              restart: unless-stopped
              healthcheck:
                test: ["CMD", "kafka-topics.sh", "--list", "--bootstrap-server", "localhost:9092"]
                interval: 15s
                timeout: 10s
                retries: 6
                start_period: 45s
          volumes:
            zookeeper_data:
            kafka_data:
          networks:
            kafka-network:
              driver: bridge
              name: banking-network
          EOF
          TOKEN=$(curl -X PUT "http://169.254.169.254/latest/api/token" -H "X-aws-ec2-metadata-token-ttl-seconds: 21600")
          PRIVATE_IP=$(curl -H "X-aws-ec2-metadata-token: $TOKEN" http://169.254.169.254/latest/meta-data/local-ipv4)
          sed -i "s/__PRIVATE_IP__/$PRIVATE_IP/" /home/ec2-user/docker-compose.yml
          /usr/local/bin/docker-compose -f /home/ec2-user/docker-compose.yml up -d  >> /home/ec2-user/userdata.log 2>&1
      Tags:
        - Key: Name
          Value: kafka-zookeeper
  CardsTable:
    Type: AWS::DynamoDB::Table
    Properties:
      TableName: Cards
      AttributeDefinitions:
        - AttributeName: cardId
          AttributeType: S
      KeySchema:
        - AttributeName: cardId
          KeyType: HASH
      ProvisionedThroughput:
        ReadCapacityUnits: 5
        WriteCapacityUnits: 5
      StreamSpecification:
        StreamViewType: NEW_IMAGE
  DynamoDBAccessRole:
    Type: AWS::IAM::Role
    Properties:
      AssumeRolePolicyDocument:
        Version: '2012-10-17'
        Statement:
          - Effect: Allow
            Principal:
              Service: ec2.amazonaws.com
            Action: sts:AssumeRole
      Policies:
        - PolicyName: DynamoDBAccess
          PolicyDocument:
            Version: '2012-10-17'
            Statement:
              - Effect: Allow
                Action:
                  - dynamodb:PutItem
                  - dynamodb:GetItem
                  - dynamodb:UpdateItem
                  - dynamodb:DeleteItem
                Resource: !Sub arn:aws:dynamodb:${AWS::Region}:${AWS::AccountId}:table/Cards
  DynamoDBInstanceProfile:
    Type: AWS::IAM::InstanceProfile
    Properties:
      Roles:
        - !Ref DynamoDBAccessRole
Outputs:
  RDSEndpoint:
    Description: Endpoint for banking-postgres
    Value: !GetAtt BankingPostgres.Endpoint.Address
    Export:
      Name: !Sub ${AWS::StackName}:RDSEndpoint
  KafkaBroker:
    Description: Kafka broker address
    Value: !Sub ${KafkaZookeeperInstance.PrivateIp}:9092
    Export:
      Name: !Sub ${AWS::StackName}:KafkaBroker
  EBSecurityGroupId:
    Description: Security group ID for EB
    Value: !Ref EBSecurityGroup
    Export:
      Name: !Sub ${AWS::StackName}:EBSecurityGroupId
  ArtifactsBucketName:
    Description: Name of the S3 bucket for artifacts
    Value: !Ref ArtifactsBucket
    Export:
      Name: !Sub ${AWS::StackName}:ArtifactsBucketName
  DynamoDBTable:
    Description: DynamoDB table for cards
    Value: !Ref CardsTable
    Export:
      Name: !Sub ${AWS::StackName}:DynamoDBTable