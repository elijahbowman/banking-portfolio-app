name: Banking Portfolio CI/CD

on:
  push:
    # branches: [main]
    branches: [main, develop, feature/sprint1-setup, feature/sprint2, feature/sprint3, feature/sprint4]
  pull_request:
    branches: [main]

env:
  JAVA_VERSION: '17'
  AWS_REGION: 'us-east-1'
  S3_BUCKET: 'banking-portfolio-artifacts'
  SKIP_DEPENDENCY_CHECK: 'true'
  OWASP_ZAP_SCAN_TARGET_HOSTNAME: 'localhost'

jobs:  
  build-and-test-banking:
    if: false
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: Build and test
      run: |
        cd backend/banking-service
        mvn clean verify -Dspring.profiles.active=test ${{ env.SKIP_DEPENDENCY_CHECK && '-Ddependency.check.skip' || '' }}

    - name: Generate JaCoCo coverage report
      run: |
        cd backend/banking-service
        mvn jacoco:report

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/banking-service/target/site/jacoco/jacoco.xml
        fail_ci_if_error: false
      # if: success() && github.ref == 'refs/heads/main'
      if: success()

    - name: Upload Dependency-Check artifact
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-sarif-banking
        path: backend/banking-service/target/dependency-check-report.sarif
    
    - name: Upload compiled classes & coverage for Sonar
      uses: actions/upload-artifact@v4
      with:
        name: compiled-classes-banking
        path: |
          backend/banking-service/target/classes
          backend/banking-service/target/site/jacoco
          backend/banking-service/target/jacoco.exec

  build-and-test-account:
    if: false
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: Build and test
      run: |
        cd backend/account-service
        mvn clean verify -Dspring.profiles.active=test ${{ env.SKIP_DEPENDENCY_CHECK && '-Ddependency.check.skip' || '' }}

    - name: Generate JaCoCo coverage report
      run: |
        cd backend/account-service
        mvn jacoco:report

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/account-service/target/site/jacoco/jacoco.xml
        fail_ci_if_error: false
      # if: success() && github.ref == 'refs/heads/main'
      if: success()

    - name: Upload Dependency-Check artifact
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-sarif-account
        path: backend/account-service/target/dependency-check-report.sarif
    
    - name: Upload compiled classes & coverage for Sonar
      uses: actions/upload-artifact@v4
      with:
        name: compiled-classes-account
        path: |
          backend/account-service/target/classes
          backend/account-service/target/site/jacoco
          backend/account-service/target/jacoco.exec

  build-and-test-card:
    if: false
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'

    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}

    - name: Build and test
      run: |
        cd backend/card-service
        mvn clean verify -Dspring.profiles.active=test ${{ env.SKIP_DEPENDENCY_CHECK && '-Ddependency.check.skip' || '' }}

    - name: Generate JaCoCo coverage report
      run: |
        cd backend/card-service
        mvn jacoco:report

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/card-service/target/site/jacoco/jacoco.xml
        fail_ci_if_error: false
      # if: success() && github.ref == 'refs/heads/main'
      if: success()

    - name: Upload Dependency-Check artifact
      uses: actions/upload-artifact@v4
      with:
        name: dependency-check-sarif-card
        path: backend/card-service/target/dependency-check-report.sarif
    
    - name: Upload compiled classes & coverage for Sonar
      uses: actions/upload-artifact@v4
      with:
        name: compiled-classes-card
        path: |
          backend/card-service/target/classes
          backend/card-service/target/site/jacoco
          backend/card-service/target/jacoco.exec
  
  build-and-test-frontend:
    if: false
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build and test
      run: |
        cd frontend
        npm ci
        npm run build
        npm run test -- --coverage

    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: frontend/coverage/lcov.info
      # if: success() && github.ref == 'refs/heads/main'
        fail_ci_if_error: false
      if: success()

  build-and-test-docker-images:
    if: false
    runs-on: ubuntu-latest 
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build Docker images
      run: |
        docker build -t banking-service:latest ./backend/banking-service
        docker build -t account-service:latest ./backend/account-service
        docker build -t frontend:latest ./frontend
      if: success()
    
    - name: Test Docker images
      run: |
        docker run -d --name banking-service --network=host banking-service:latest
        docker run -d --name account-service --network=host account-service:latest
        sleep 60
        curl -f http://localhost:8080/actuator/health || exit 1
        curl -f http://localhost:8081/actuator/health || exit 1
        docker stop banking-service account-service
      if: success()

  sonarqube-scan:
    if: false
    needs: [build-and-test-banking, build-and-test-account, build-and-test-card, build-and-test-frontend]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 0   # Required for accurate code coverage & blame data

    - name: Download ALL compiled classes at once
      uses: actions/download-artifact@v4
      with:
        path: downloaded-artifacts
        pattern: compiled-classes-*
        merge-multiple: true

    - name: Restore flattened classes to correct directory structure
      run: |
        # Create target directories
        mkdir -p backend/banking-service/target/classes
        mkdir -p backend/account-service/target/classes
        mkdir -p backend/card-service/target/classes

        # Move everything from the flattened structure back
        # Banking service classes
        cp -r downloaded-artifacts/classes/* backend/banking-service/target/classes/ 2>/dev/null || true
        cp -r downloaded-artifacts/jacoco.exec backend/banking-service/target/ 2>/dev/null || true
        cp -r downloaded-artifacts/site backend/banking-service/target/ 2>/dev/null || true

        # Account service (same structure, just copy again â€” safe overwrite)
        cp -r downloaded-artifacts/classes/* backend/account-service/target/classes/ 2>/dev/null || true
        cp -r downloaded-artifacts/jacoco.exec backend/account-service/target/ 2>/dev/null || true
        cp -r downloaded-artifacts/site backend/account-service/target/ 2>/dev/null || true

        # Card service
        cp -r downloaded-artifacts/classes/* backend/card-service/target/classes/ 2>/dev/null || true
        cp -r downloaded-artifacts/jacoco.exec backend/card-service/target/ 2>/dev/null || true
        cp -r downloaded-artifacts/site backend/card-service/target/ 2>/dev/null || true

        echo "Restored files:"
        find backend -name "*.class" | wc -l

    - name: SonarQube Scan
      uses: sonarsource/sonarqube-scan-action@v6
      # uses: SonarSource/sonarcloud-github-action@master
      env:
        SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
      with:
        args: >
          -Dsonar.organization=${{ secrets.SONAR_ORG_KEY }}
          -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }}
          -Dsonar.qualitygate.wait=true
          -Dsonar.verbose=true
          -Dsonar.java.binaries=backend/banking-service/target/classes,backend/account-service/target/classes,backend/card-service/target/classes
          -Dsonar.coverage.jacoco.xmlReportPaths=backend/banking-service/target/site/jacoco/jacoco.xml,backend/account-service/target/site/jacoco/jacoco.xml,backend/card-service/target/site/jacoco/jacoco.xml
  
  owasp-zap-scan:
    if: false
    needs: [build-and-test-banking, build-and-test-account, build-and-test-card, build-and-test-frontend]
    runs-on: ubuntu-latest
    steps:
    - uses: actions/checkout@v4

    - name: Set up Docker Buildx  # Ensures Docker CLI v2+ (includes compose)
      uses: docker/setup-buildx-action@v3

    - name: Start all services (Docker Compose)
      run: |
        docker compose -f docker-compose.ci-cd.yml up -d        
        sleep 60
        docker compose ps

    - name: Run OWASP ZAP Baseline Scan
      uses: zaproxy/action-baseline@v0.15.0
      with:
        target: http://${{ env.OWASP_ZAP_SCAN_TARGET_HOSTNAME }}:80   # Docker gateway IP for frontend
        # Alternative: scan backend APIs
        # target: |
        #   http://${{ env.OWASP_ZAP_SCAN_TARGET_HOSTNAME }}:8080
        #   http://${{ env.OWASP_ZAP_SCAN_TARGET_HOSTNAME }}:8081
        #   http://${{ env.OWASP_ZAP_SCAN_TARGET_HOSTNAME }}:8082
        cmd_options: -a   # include informational alerts
        fail_action: false   # allow Low/Info alerts (they're expected in dev)
        artifact_name: zap-report
        allow_issue_writing: false

    - name: Upload ZAP Report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: zap-scan-report
        path: zap-baseline-report.*

  # security-scan:
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   steps:
  #   - name: Download Dependency-Check artifact
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: dependency-check-sarif
  #       path: backend/
    
  #   - name: Upload SARIF file
  #     uses: github/codeql-action/upload-sarif@v3
  #     with:
  #       sarif_file: |
  #         backend/banking-service/target/dependency-check-report.sarif
  #         backend/account-service/target/dependency-check-report.sarif
  #         backend/card-service/target/dependency-check-report.sarif
  #     if: always()

  deploy-infrastructure-core:
    if: false
    # if: github.ref == 'refs/heads/feature/main' && github.event_name == 'push'
    # if: (github.ref == 'refs/heads/feature/main' || github.ref == 'refs/heads/feature/sprint1-setup' || github.ref == 'refs/heads/feature/sprint2' || github.ref == 'refs/heads/feature/sprint3' || github.ref == 'refs/heads/feature/sprint4') && github.event_name == 'push'
    # needs: [sonarqube-scan, owasp-zap-scan]
    needs: [owasp-zap-scan]
    # needs: [build-and-test-banking, build-and-test-account, build-and-test-card, build-and-test-frontend, security-scan]
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    # - name: Delete old EB infrastructure stack
    #   run: |
    #     if aws s3 ls s3://${{ env.S3_BUCKET }}/ >/dev/null 2>&1; then
    #       aws s3 rm s3://${{ env.S3_BUCKET }} --recursive
    #     fi
    #     aws cloudformation delete-stack \
    #       --stack-name banking-portfolio-eb \
    #       --region ${{ env.AWS_REGION }}
    #     aws cloudformation wait stack-delete-complete \
    #       --stack-name banking-portfolio-eb \
    #       --region ${{ env.AWS_REGION }}

    # - name: Delete old core infrastructure stack
    #   run: |
    #     aws cloudformation delete-stack \
    #       --stack-name banking-portfolio-core \
    #       --region ${{ env.AWS_REGION }}
    #     aws cloudformation wait stack-delete-complete \
    #       --stack-name banking-portfolio-core \
    #       --region ${{ env.AWS_REGION }}

    - name: Deploy core infrastructure stack
      run: |
        aws cloudformation deploy \
          --stack-name banking-portfolio-core \
          --template-file infrastructure/infrastructure-core.yml \
          --parameter-overrides \
            VpcId=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) \
            SubnetId1=$(aws ec2 describe-subnets --region ${{ env.AWS_REGION }} --filters Name=vpc-id,Values=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) --query 'Subnets[?AvailabilityZone==`us-east-1a`].SubnetId' --output text | head -n 1) \
            SubnetId2=$(aws ec2 describe-subnets --region ${{ env.AWS_REGION }} --filters Name=vpc-id,Values=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) --query 'Subnets[?AvailabilityZone==`us-east-1b`].SubnetId' --output text | head -n 1) \
            KeyName=banking-kafka-key \
            YourIP=${{ secrets.YOUR_PUBLIC_IP }}/32 \
          --region ${{ env.AWS_REGION }} \
          --capabilities CAPABILITY_NAMED_IAM \
          --no-fail-on-empty-changeset

  deploy-card-lambda:
    # if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/develop'
    if: (github.ref == 'refs/heads/feature/main' || github.ref == 'refs/heads/feature/sprint1-setup' || github.ref == 'refs/heads/feature/sprint2' || github.ref == 'refs/heads/feature/sprint3' || github.ref == 'refs/heads/feature/sprint4') && github.event_name == 'push'
    # needs: deploy-infrastructure-core
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: 17
          distribution: temurin

      - name: Build Lambda JAR
        run: |
          cd backend/card-service
          echo "Working Directory: "
          pwd
          echo "Files backend/card-service in directory: "
          ls -la
          mvn clean package -DskipTests
          echo "Files in target folder: "
          ls -la target/

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1

      - name: Setup AWS SAM CLI
        uses: aws-actions/setup-sam@v2
        with:
          version: 1.128.0

      - name: Cache Docker layers
        uses: actions/cache@v3
        with:
          path: /tmp/.buildkit
          key: ${{ runner.os }}-sam-buildkit-${{ hashFiles('pom.xml') }}
          restore-keys: ${{ runner.os }}-sam-buildkit-

      - name: Deploy with AWS SAM
        env:
          SAM_CLI_TELEMETRY: 0
          MAVEN_OPTS: "-DskipTests=true -Ddependency.check.skip=true -X"
        run: |
          cd backend/card-service
          echo "Working Directory: "
          pwd
          echo "Files in target folder: "
          ls -la target/
          sam build --use-container --container-env-var MAVEN_OPTS="${MAVEN_OPTS}"
          # sam build --use-container --parameter-overrides MavenCommand="clean package -DskipTests=true -Ddependency.check.skip=true"
          sam deploy \
            --stack-name banking-card-lambda \
            --s3-bucket ${{ env.S3_BUCKET }} \
            --no-confirm-changeset \
            --no-fail-on-empty-changeset \
            --region us-east-1 \
            --capabilities CAPABILITY_IAM CAPABILITY_AUTO_EXPAND

      - name: Output Lambda API URL
        run: |
          URL=$(aws cloudformation describe-stacks --stack-name banking-card-lambda --query 'Stacks[0].Outputs[?OutputKey==`CardServiceApiUrl`].OutputValue' --output text)
          echo "Card Service Lambda URL: $URL"
          echo "CARD_SERVICE_URL=$URL" >> $GITHUB_ENV

  deploy-infrastructure-eb:
    # if: false
    # if: github.ref == 'refs/heads/feature/main' && github.event_name == 'push'
    if: (github.ref == 'refs/heads/feature/main' || github.ref == 'refs/heads/feature/sprint1-setup' || github.ref == 'refs/heads/feature/sprint2' || github.ref == 'refs/heads/feature/sprint3' || github.ref == 'refs/heads/feature/sprint4') && github.event_name == 'push'
    needs: deploy-card-lambda
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}    

    - name: Deploy EB infrastructure stack
      run: |
        aws cloudformation deploy \
          --stack-name banking-portfolio-eb \
          --template-file infrastructure/infrastructure-eb.yml \
          --parameter-overrides \
            VpcId=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) \
            SubnetId1=$(aws ec2 describe-subnets --region ${{ env.AWS_REGION }} --filters Name=vpc-id,Values=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) --query 'Subnets[?AvailabilityZone==`us-east-1a`].SubnetId' --output text | head -n 1) \
            SubnetId2=$(aws ec2 describe-subnets --region ${{ env.AWS_REGION }} --filters Name=vpc-id,Values=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) --query 'Subnets[?AvailabilityZone==`us-east-1b`].SubnetId' --output text | head -n 1) \
            ArtifactsBucketName=${{ env.S3_BUCKET }} \
          --region ${{ env.AWS_REGION }} \
          --capabilities CAPABILITY_NAMED_IAM \
          --no-fail-on-empty-changeset

  deploy-application:
    if: false
    # if: github.ref == 'refs/heads/feature/main' && github.event_name == 'push'
    # if: (github.ref == 'refs/heads/feature/main' || github.ref == 'refs/heads/feature/sprint1-setup' || github.ref == 'refs/heads/feature/sprint2' || github.ref == 'refs/heads/feature/sprint3' || github.ref == 'refs/heads/feature/sprint4') && github.event_name == 'push'
    needs: deploy-infrastructure-eb
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Build with Maven
      run: |
        cd backend/banking-service
        mvn clean package -DskipTests
        cd ../account-service
        mvn clean package -DskipTests

    - name: Build Frontend
      run: |
        cd frontend
        npm install
        npm run build

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker images
      run: |
        docker build -t banking-service:latest ./backend/banking-service
        docker build -t account-service:latest ./backend/account-service
        docker build -t card-service:latest ./backend/card-service
        docker build -t frontend:latest ./frontend

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push Docker images to Docker Hub
      run: |
        docker tag banking-service:latest ${{ secrets.DOCKERHUB_USERNAME }}/banking-service:latest
        docker tag account-service:latest ${{ secrets.DOCKERHUB_USERNAME }}/account-service:latest
        docker tag card-service:latest ${{ secrets.DOCKERHUB_USERNAME }}/card-service:latest
        docker tag frontend:latest ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/banking-service:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/account-service:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/card-service:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest

    - name: Create Dockerrun.aws.json(s)
      run: |
        cat > backend/banking-service/Dockerrun.aws.json << EOF
        {
          "AWSEBDockerrunVersion": "1",
          "Image": {
            "Name": "${{ secrets.DOCKERHUB_USERNAME }}/banking-service:latest",
            "Update": "true"
          },
          "Ports": [
            {
              "ContainerPort": 8080,
              "HostPort": 80
            }
          ],
          "Logging": "/app/logs",
          "Environment": [
            {
              "Name": "SPRING_PROFILES_ACTIVE",
              "Value": "docker"
            }
          ]
        }
        EOF
        cat > backend/account-service/Dockerrun.aws.json << EOF
        {
          "AWSEBDockerrunVersion": "1",
          "Image": {
            "Name": "${{ secrets.DOCKERHUB_USERNAME }}/account-service:latest",
            "Update": "true"
          },
          "Ports": [
            {
              "ContainerPort": 8081,
              "HostPort": 8081
            }
          ],
          "Logging": "/app/logs",
          "Environment": [
            {
              "Name": "SPRING_PROFILES_ACTIVE",
              "Value": "docker"
            }
          ]
        }
        EOF
        cat > frontend/Dockerrun.aws.json << EOF
        {
          "AWSEBDockerrunVersion": "1",
          "Image": {
            "Name": "${{ secrets.DOCKERHUB_USERNAME }}/frontend:latest",
            "Update": "true"
          },
          "Ports": [
            {
              "ContainerPort": 80,
              "HostPort": 80
            }
          ],
          "Logging": "/var/log/nginx"
        }
        EOF

    - name: Create source bundles
      run: |
        cd backend/banking-service
        zip -r source-bundle.zip Dockerrun.aws.json
        cd ../account-service
        zip -r source-bundle.zip Dockerrun.aws.json
        cd ../card-service
        zip -r source-bundle.zip Dockerrun.aws.json
        cd ../../frontend
        zip -r source-bundle.zip Dockerrun.aws.json

    # - name: Create .dockercfg for Docker Hub
    #   run: |
    #     cat > backend/banking-service/.dockercfg << EOF
    #     {
    #       "auths": {
    #         "https://index.docker.io/v1/": {
    #           "auth": "$(echo -n '${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}' | base64)"
    #         }
    #       }
    #     }
    #     EOF
    #     aws s3 cp backend/banking-service/.dockercfg s3://${{ env.S3_BUCKET }}/dockercfg


    
    - name: Clean up old application versions
      run: |
        # Log bucket status for debugging
        echo "Checking bucket s3://${{ env.S3_BUCKET }}"
        aws s3 ls s3://${{ env.S3_BUCKET }}/ && echo "Bucket s3://${{ env.S3_BUCKET }} exists" || echo "Bucket s3://${{ env.S3_BUCKET }} does not exist"
        
        echo "Checking bucket s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}"
        aws s3 ls s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/ && echo "Bucket s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} exists" || echo "Bucket s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} does not exist"

        # Clean up old EB application versions
        aws elasticbeanstalk describe-application-versions \
          --application-name banking-portfolio \
          --region ${{ env.AWS_REGION }} \
          --query 'ApplicationVersions[?VersionLabel!=`v${{ github.run_number }}`].VersionLabel' --output text | \
        xargs -n 1 -r aws elasticbeanstalk delete-application-version \
          --application-name banking-portfolio \
          --region ${{ env.AWS_REGION }} \
          --delete-source-bundle \
          --version-label

        # Clean banking-portfolio-artifacts bucket
        if aws s3 ls s3://${{ env.S3_BUCKET }}/ >/dev/null 2>&1; then
          aws s3 rm s3://${{ env.S3_BUCKET }}/ --recursive --exclude "dockercfg" || echo "Failed to clean s3://${{ env.S3_BUCKET }}, continuing..."
        else
          echo "Bucket s3://${{ env.S3_BUCKET }} does not exist, skipping cleanup"
        fi

        # Clean elasticbeanstalk bucket
        if aws s3 ls s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/ >/dev/null 2>&1; then
          aws s3 rm s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/ --recursive || echo "Failed to clean s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}, continuing..."
        else
          echo "Bucket s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} does not exist, skipping cleanup"
        fi

    - name: Upload source bundles to S3
      run: |
        aws s3 cp backend/banking-service/source-bundle.zip s3://${{ env.S3_BUCKET }}/banking-service-v${{ github.run_number }}.zip
        aws s3 cp backend/account-service/source-bundle.zip s3://${{ env.S3_BUCKET }}/account-service-v${{ github.run_number }}.zip
        aws s3 cp frontend/source-bundle.zip s3://${{ env.S3_BUCKET }}/frontend-v${{ github.run_number }}.zip

    - name: Create EB application version
      run: |
        aws elasticbeanstalk create-application-version \
          --application-name banking-portfolio \
          --version-label banking-v${{ github.run_number }} \
          --source-bundle S3Bucket=${{ env.S3_BUCKET }},S3Key=banking-service-v${{ github.run_number }}.zip \
          --region ${{ env.AWS_REGION }}
        aws elasticbeanstalk create-application-version \
          --application-name banking-portfolio \
          --version-label account-v${{ github.run_number }} \
          --source-bundle S3Bucket=${{ env.S3_BUCKET }},S3Key=account-service-v${{ github.run_number }}.zip \
          --region ${{ env.AWS_REGION }}
        aws elasticbeanstalk create-application-version \
          --application-name banking-portfolio \
          --version-label frontend-v${{ github.run_number }} \
          --source-bundle S3Bucket=${{ env.S3_BUCKET }},S3Key=frontend-v${{ github.run_number }}.zip \
          --region ${{ env.AWS_REGION }}

    - name: Wait for environments to be ready
      run: |
        echo "Waiting for banking-env to be in Ready state..."
        for i in {1..30}; do
          STATUS=$(aws elasticbeanstalk describe-environment-health \
            --environment-name banking-env \
            --attribute-names Status \
            --region ${{ env.AWS_REGION }} \
            --query 'Status' --output text)
          if [ "$STATUS" = "Ready" ]; then
            echo "Environment is Ready"
            break
          fi
          echo "Environment status: $STATUS, waiting 10 seconds..."
          sleep 10
        done
        if [ "$STATUS" != "Ready" ]; then
          echo "Error: Environment not in Ready state after 300 seconds"
          exit 1
        fi

        for i in {1..30}; do
          STATUS=$(aws elasticbeanstalk describe-environment-health \
            --environment-name account-env \
            --attribute-names Status \
            --region ${{ env.AWS_REGION }} \
            --query 'Status' --output text)
          if [ "$STATUS" = "Ready" ]; then
            echo "Environment is Ready"
            break
          fi
          echo "Environment status: $STATUS, waiting 10 seconds..."
          sleep 10
        done
        if [ "$STATUS" != "Ready" ]; then
          echo "Error: Environment not in Ready state after 300 seconds"
          exit 1
        fi

        for i in {1..30}; do
          STATUS=$(aws elasticbeanstalk describe-environment-health \
            --environment-name frontend-env \
            --attribute-names Status \
            --region ${{ env.AWS_REGION }} \
            --query 'Status' --output text)
          if [ "$STATUS" = "Ready" ]; then
            echo "Environment is Ready"
            break
          fi
          echo "Environment status: $STATUS, waiting 10 seconds..."
          sleep 10
        done
        if [ "$STATUS" != "Ready" ]; then
          echo "Error: Environment not in Ready state after 300 seconds"
          exit 1
        fi

    - name: Deploy to EB environment
      run: |
        aws elasticbeanstalk update-environment \
          --application-name banking-portfolio \
          --environment-name banking-env \
          --version-label banking-v${{ github.run_number }} \
          --region ${{ env.AWS_REGION }}
        aws elasticbeanstalk update-environment \
          --application-name banking-portfolio \
          --environment-name account-env \
          --version-label account-v${{ github.run_number }} \
          --region ${{ env.AWS_REGION }}
        aws elasticbeanstalk update-environment \
          --application-name banking-portfolio \
          --environment-name frontend-env \
          --version-label frontend-v${{ github.run_number }} \
          --region ${{ env.AWS_REGION }}
    
    - name: Smoke tests on AWS
      run: |
        sleep 180
        BANKING_URL=$(aws elasticbeanstalk describe-environments \
          --application-name banking-portfolio \
          --environment-name banking-env \
          --region ${{ env.AWS_REGION }} \
          --query 'Environments[0].CNAME' --output text)
        ACCOUNT_URL=$(aws elasticbeanstalk describe-environments \
          --application-name banking-portfolio \
          --environment-name account-env \
          --region ${{ env.AWS_REGION }} \
          --query 'Environments[0].CNAME' --output text)
        FRONTEND_URL=$(aws elasticbeanstalk describe-environments \
          --application-name banking-portfolio \
          --environment-name frontend-env \
          --region ${{ env.AWS_REGION }} \
          --query 'Environments[0].CNAME' --output text)
        curl -f http://$BANKING_URL/actuator/health
        curl -f http://$ACCOUNT_URL/actuator/health
        curl -f http://$FRONTEND_URL
        curl -f -X POST "http://$BANKING_URL/api/v1/banking/deposits" -H "Content-Type: application/json" -d '{"accountId":"smoke","amount":1.00}'
        # curl -f "http://$ACCOUNT_URL/api/v1/accounts/balance?accountId=smoke"

    # - name: Notify deployment success
    #   if: success()
    #   uses: slackapi/slack-github-action@v1
    #   with:
    #     slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
    #     channel-id: 'deployments'
    #     text: "ðŸš€ Banking Portfolio deployed to AWS Elastic Beanstalk successfully!"
    #   env:
    #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

    # - name: Notify deployment failure
    #   if: failure()
    #   uses: slackapi/slack-github-action@v1
    #   with:
    #     slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
    #     channel-id: 'deployments'
    #     text: "ðŸ’¥ Banking Portfolio deployment to AWS failed!"
    #   env:
    #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}