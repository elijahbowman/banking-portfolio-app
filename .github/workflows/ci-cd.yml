name: Banking Portfolio CI/CD

on:
  push:
    branches: [main, develop, feature/sprint1-setup]
  pull_request:
    branches: [main]

env:
  JAVA_VERSION: '17'
  AWS_REGION: 'us-east-1'
  S3_BUCKET: 'banking-portfolio-artifacts'

jobs:
  build-and-test:
    # if: false
    runs-on: ubuntu-latest
    services:
      postgres:
        image: postgres:15-alpine
        env:
          POSTGRES_USER: testuser
          POSTGRES_PASSWORD: testpass
          POSTGRES_DB: testdb
        ports:
          - 5432:5432
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
      kafka:
        image: bitnamilegacy/kafka:3.7
        ports:
          - 9092:9092
        env:
          KAFKA_CFG_ZOOKEEPER_CONNECT: zookeeper:2181
          KAFKA_CFG_LISTENER_SECURITY_PROTOCOL_MAP: PLAINTEXT:PLAINTEXT
          KAFKA_CFG_LISTENERS: PLAINTEXT://:9092
          KAFKA_CFG_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
          KAFKA_CFG_BROKER_ID: 1
          KAFKA_CFG_AUTO_CREATE_TOPICS_ENABLE: "true"
          KAFKA_CFG_NUM_PARTITIONS: 1
          KAFKA_CFG_DEFAULT_REPLICATION_FACTOR: 1
          KAFKA_CFG_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
          ALLOW_PLAINTEXT_LISTENER: "yes"
        options: >-
          --health-cmd "kafka-topics.sh --list --bootstrap-server localhost:9092"
          --health-interval 15s
          --health-timeout 10s
          --health-retries 6
          --health-start-period 45s
      zookeeper:
        image: bitnamilegacy/zookeeper:3.9
        ports:
          - 2181:2181
        env:
          ALLOW_ANONYMOUS_LOGIN: yes
        options: >-
          --health-cmd "zkServer.sh status | grep 'Mode: standalone' || exit 1"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 10
          --health-start-period 60s
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      
    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'
        cache: 'maven'
      
    - name: Cache Maven packages
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2
    
    - name: Cache NVD Database
      uses: actions/cache@v3
      with:
        path: ~/.m2/repository/org/owasp/dependency-check-data
        key: nvd-cache-${{ runner.os }}-${{ hashFiles('**/pom.xml') }}
        restore-keys: nvd-cache-${{ runner.os }}-
    
    - name: Build and test with Maven (PostgreSQL)
      run: |
        cd backend/banking-service
        mvn clean verify -Dspring.profiles.active=test
      env:
        SPRING_DATASOURCE_URL: jdbc:postgresql://localhost:5432/testdb
        SPRING_DATASOURCE_USERNAME: testuser
        SPRING_DATASOURCE_PASSWORD: testpass
        SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.postgresql.Driver
        SPRING_KAFKA_BOOTSTRAP_SERVERS: localhost:9092

    - name: Fallback test with H2 (if PostgreSQL fails)
      if: failure()
      run: |
        cd backend/banking-service
        mvn clean verify -Dspring.profiles.active=test
      env:
        SPRING_DATASOURCE_URL: jdbc:h2:mem:testdb;DB_CLOSE_DELAY=-1
        SPRING_DATASOURCE_USERNAME: sa
        SPRING_DATASOURCE_PASSWORD: ''
        SPRING_DATASOURCE_DRIVER_CLASS_NAME: org.h2.Driver
        SPRING_KAFKA_BOOTSTRAP_SERVERS: localhost:9092
    
    - name: Generate JaCoCo coverage report
      run: |
        cd backend/banking-service
        mvn jacoco:report
      if: success()
    
    - name: Upload coverage to Codecov
      uses: codecov/codecov-action@v3
      with:
        file: backend/banking-service/target/site/jacoco/jacoco.xml
        fail_ci_if_error: false
      if: success() && github.ref == 'refs/heads/main'
    
    # - name: Upload Dependency-Check artifact
    #   uses: actions/upload-artifact@v4
    #   with:
    #     name: dependency-check-sarif
    #     path: backend/banking-service/target/dependency-check-report.sarif
        
    - name: Build Docker image
      run: |
        docker build -t banking-service:test ./backend/banking-service
      if: success()
    
    - name: Test Docker image
      run: |
        docker run --rm --network=host banking-service:test &
        CONTAINER_PID=$!
        sleep 30
        curl -f http://localhost:8080/actuator/health || exit 1
        docker stop $CONTAINER_PID 2>/dev/null || true
      if: success()

  # security-scan:
  #   runs-on: ubuntu-latest
  #   needs: build-and-test
  #   steps:
  #   - name: Download Dependency-Check artifact
  #     uses: actions/download-artifact@v4
  #     with:
  #       name: dependency-check-sarif
  #       path: backend/banking-service/target/
    
  #   - name: Upload SARIF file
  #     uses: github/codeql-action/upload-sarif@v3
  #     with:
  #       sarif_file: backend/banking-service/target/dependency-check-report.sarif
  #     if: always()

  deploy-infrastructure:
    runs-on: ubuntu-latest
    # needs: [build-and-test, security-scan]
    needs: [build-and-test]
    # if: false
    # if: github.ref == 'refs/heads/feature/main' && github.event_name == 'push'
    if: github.ref == 'refs/heads/feature/sprint1-setup' && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Delete old EB infrastructure stack
      run: |
        if aws s3 ls s3://${{ env.S3_BUCKET }}/ >/dev/null 2>&1; then
          aws s3 rm s3://${{ env.S3_BUCKET }} --recursive
        fi
        aws cloudformation delete-stack \
          --stack-name banking-portfolio-eb \
          --region ${{ env.AWS_REGION }}
        aws cloudformation wait stack-delete-complete \
          --stack-name banking-portfolio-eb \
          --region ${{ env.AWS_REGION }}

    # - name: Delete old core infrastructure stack
    #   run: |
    #     aws cloudformation delete-stack \
    #       --stack-name banking-portfolio-core \
    #       --region ${{ env.AWS_REGION }}
    #     aws cloudformation wait stack-delete-complete \
    #       --stack-name banking-portfolio-core \
    #       --region ${{ env.AWS_REGION }}

    - name: Deploy core infrastructure stack
      run: |
        aws cloudformation deploy \
          --stack-name banking-portfolio-core \
          --template-file infrastructure/infrastructure-core.yml \
          --parameter-overrides \
            VpcId=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) \
            SubnetId1=$(aws ec2 describe-subnets --region ${{ env.AWS_REGION }} --filters Name=vpc-id,Values=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) --query 'Subnets[?AvailabilityZone==`us-east-1a`].SubnetId' --output text | head -n 1) \
            SubnetId2=$(aws ec2 describe-subnets --region ${{ env.AWS_REGION }} --filters Name=vpc-id,Values=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) --query 'Subnets[?AvailabilityZone==`us-east-1b`].SubnetId' --output text | head -n 1) \
            KeyName=banking-kafka-key \
            YourIP=${{ secrets.YOUR_PUBLIC_IP }}/32 \
          --region ${{ env.AWS_REGION }} \
          --capabilities CAPABILITY_NAMED_IAM \
          --no-fail-on-empty-changeset

    - name: Deploy EB infrastructure stack
      run: |
        aws cloudformation deploy \
          --stack-name banking-portfolio-eb \
          --template-file infrastructure/infrastructure-eb.yml \
          --parameter-overrides \
            VpcId=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) \
            SubnetId1=$(aws ec2 describe-subnets --region ${{ env.AWS_REGION }} --filters Name=vpc-id,Values=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) --query 'Subnets[?AvailabilityZone==`us-east-1a`].SubnetId' --output text | head -n 1) \
            SubnetId2=$(aws ec2 describe-subnets --region ${{ env.AWS_REGION }} --filters Name=vpc-id,Values=$(aws ec2 describe-vpcs --region ${{ env.AWS_REGION }} --query 'Vpcs[0].VpcId' --output text) --query 'Subnets[?AvailabilityZone==`us-east-1b`].SubnetId' --output text | head -n 1) \
            ArtifactsBucketName=${{ env.S3_BUCKET }} \
          --region ${{ env.AWS_REGION }} \
          --capabilities CAPABILITY_NAMED_IAM \
          --no-fail-on-empty-changeset

  deploy-application:
    runs-on: ubuntu-latest
    needs: deploy-infrastructure
    # if: false
    # if: github.ref == 'refs/heads/feature/main' && github.event_name == 'push'
    if: github.ref == 'refs/heads/feature/sprint1-setup' && github.event_name == 'push'
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Set up JDK ${{ env.JAVA_VERSION }}
      uses: actions/setup-java@v4
      with:
        java-version: ${{ env.JAVA_VERSION }}
        distribution: 'temurin'

    - name: Configure AWS credentials
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
        aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
        aws-region: ${{ env.AWS_REGION }}

    - name: Build with Maven
      run: |
        cd backend/banking-service
        mvn clean package -DskipTests

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      run: docker build -t banking-service:latest ./backend/banking-service

    - name: Login to Docker Hub
      uses: docker/login-action@v3
      with:
        username: ${{ secrets.DOCKERHUB_USERNAME }}
        password: ${{ secrets.DOCKERHUB_TOKEN }}

    - name: Push Docker image to Docker Hub
      run: |
        docker tag banking-service:latest ${{ secrets.DOCKERHUB_USERNAME }}/banking-service:latest
        docker push ${{ secrets.DOCKERHUB_USERNAME }}/banking-service:latest

    - name: Create Dockerrun.aws.json
      run: |
        cat > backend/banking-service/Dockerrun.aws.json << EOF
        {
          "AWSEBDockerrunVersion": "1",
          "Image": {
            "Name": "${{ secrets.DOCKERHUB_USERNAME }}/banking-service:latest",
            "Update": "true"
          },
          "Ports": [
            {
              "ContainerPort": 8080,
              "HostPort": 80
            }
          ],
          "Logging": "/app/logs",
          "Environment": [
            {
              "Name": "SPRING_PROFILES_ACTIVE",
              "Value": "docker"
            }
          ]
        }
        EOF

    - name: Create source bundle
      run: |
        cd backend/banking-service
        zip -r source-bundle.zip Dockerrun.aws.json .ebextensions

    - name: Create .dockercfg for Docker Hub
      run: |
        cat > backend/banking-service/.dockercfg << EOF
        {
          "auths": {
            "https://index.docker.io/v1/": {
              "auth": "$(echo -n '${{ secrets.DOCKERHUB_USERNAME }}:${{ secrets.DOCKERHUB_TOKEN }}' | base64)"
            }
          }
        }
        EOF
        aws s3 cp backend/banking-service/.dockercfg s3://${{ env.S3_BUCKET }}/dockercfg
    
    - name: Clean up old application versions
      run: |
        # Log bucket status for debugging
        echo "Checking bucket s3://${{ env.S3_BUCKET }}"
        aws s3 ls s3://${{ env.S3_BUCKET }}/ && echo "Bucket s3://${{ env.S3_BUCKET }} exists" || echo "Bucket s3://${{ env.S3_BUCKET }} does not exist"
        echo "Checking bucket s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}"
        aws s3 ls s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/ && echo "Bucket s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} exists" || echo "Bucket s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} does not exist"

        # Clean up old EB application versions
        aws elasticbeanstalk describe-application-versions \
          --application-name banking-portfolio \
          --region ${{ env.AWS_REGION }} \
          --query 'ApplicationVersions[?VersionLabel!=`v${{ github.run_number }}`].VersionLabel' --output text | \
          xargs -n 1 -r aws elasticbeanstalk delete-application-version \
          --application-name banking-portfolio \
          --region ${{ env.AWS_REGION }} \
          --delete-source-bundle \
          --version-label

        # Clean banking-portfolio-artifacts bucket
        if aws s3 ls s3://${{ env.S3_BUCKET }}/ >/dev/null 2>&1; then
          aws s3 rm s3://${{ env.S3_BUCKET }}/ --recursive --exclude "dockercfg" || echo "Failed to clean s3://${{ env.S3_BUCKET }}, continuing..."
        else
          echo "Bucket s3://${{ env.S3_BUCKET }} does not exist, skipping cleanup"
        fi

        # Clean elasticbeanstalk bucket
        if aws s3 ls s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/ >/dev/null 2>&1; then
          aws s3 rm s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}/ --recursive || echo "Failed to clean s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }}, continuing..."
        else
          echo "Bucket s3://elasticbeanstalk-${{ env.AWS_REGION }}-${{ secrets.AWS_ACCOUNT_ID }} does not exist, skipping cleanup"
        fi

    - name: Upload source bundle to S3
      run: |
        aws s3 cp backend/banking-service/source-bundle.zip s3://${{ env.S3_BUCKET }}/source-bundle-v${{ github.run_number }}.zip

    - name: Create EB application version
      run: |
        aws elasticbeanstalk create-application-version \
          --application-name banking-portfolio \
          --version-label v${{ github.run_number }} \
          --source-bundle S3Bucket=${{ env.S3_BUCKET }},S3Key=source-bundle-v${{ github.run_number }}.zip \
          --region ${{ env.AWS_REGION }}

    - name: Wait for environment to be ready
      run: |
        echo "Waiting for banking-env to be in Ready state..."
        for i in {1..30}; do
          STATUS=$(aws elasticbeanstalk describe-environment-health \
            --environment-name banking-env \
            --attribute-names Status \
            --region ${{ env.AWS_REGION }} \
            --query 'Status' --output text)
          if [ "$STATUS" = "Ready" ]; then
            echo "Environment is Ready"
            break
          fi
          echo "Environment status: $STATUS, waiting 10 seconds..."
          sleep 10
        done
        if [ "$STATUS" != "Ready" ]; then
          echo "Error: Environment not in Ready state after 300 seconds"
          exit 1
        fi

    - name: Deploy to EB environment
      run: |
        aws elasticbeanstalk update-environment \
          --application-name banking-portfolio \
          --environment-name banking-env \
          --version-label v${{ github.run_number }} \
          --region ${{ env.AWS_REGION }}
    
    - name: Smoke tests on AWS
      run: |
        sleep 180
        ENVIRONMENT_URL=$(aws elasticbeanstalk describe-environments \
          --application-name banking-portfolio \
          --environment-name banking-env \
          --region ${{ env.AWS_REGION }} \
          --query 'Environments[0].CNAME' --output text)
        curl -f http://$ENVIRONMENT_URL/actuator/health
        curl -f -X POST "http://$ENVIRONMENT_URL/api/v1/banking/deposits?accountId=smoke&amount=1.00"

    # - name: Notify deployment success
    #   if: success()
    #   uses: slackapi/slack-github-action@v1
    #   with:
    #     slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
    #     channel-id: 'deployments'
    #     text: "ðŸš€ BankingService deployed to AWS Elastic Beanstalk successfully!"
    #   env:
    #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}

    # - name: Notify deployment failure
    #   if: failure()
    #   uses: slackapi/slack-github-action@v1
    #   with:
    #     slack-bot-token: ${{ secrets.SLACK_BOT_TOKEN }}
    #     channel-id: 'deployments'
    #     text: "ðŸ’¥ BankingService deployment to AWS failed!"
    #   env:
    #     SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}